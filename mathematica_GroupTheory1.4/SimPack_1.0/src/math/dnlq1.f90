!****m* src/dnlq1.f90
!
! NAME
!  dnlq1.f90
!
! AUTHOR
!  W. Hergert (small changes to F90)
!
!  Schwetlick, H. and Poenisch, G. and Schmidt, G. and Knauf, L.
!  Program DNLQ1
!  Math. Bibl. FORTRAN
!  Computer station of MLU Halle-Wittenberg, Halle
!  1976
!
! USAGE
!     BESTIMMUNG DER QUADRATMITTELLOESUNG EINES UEBERBESTIMMTEN NICHT-
!     LINEAREN GLEICHUNGSSYSTEMS F(X)=0 MIT HILFE EINES DISKRETISIER-
!     TEN REGULARISIERTEN GAUSS-NEWTON-VERFAHRENS
!
!     SUBROUTINE DNLQ1(N,X,M,F,F1,EPSREL,EFX,EGRAD,ITM,IPRINT,IE,WORK)
!     REAL(DP) :: X(N),WORK(2*M+3*N+M*N (+M*N) )
!     REAL(DP) :: EPSREL,EFX,EGRAD
!     EXTERNAL F1
!
!     Das Modell wird im Unterprogramm F definiert.
!
! INPUT
!     PARAMETER VON DNLQ1:
!
!      N       -  ANZAHL DER UNBEKANNTEN
!      M       -  ANZAHL DER GLEICHUNGEN (M>=N)
!      X       -  FELD MIT N ELEMENTEN
!                  E: AUSGANGSNAEHERUNG X0
!                  A: NAEHERUNGSLOESUNG XSTERN
!      F       -  NAME DER SUBROUTINE ZUR BERECHNUNG DES FUNKTIONS-
!                 WERTVEKTORS
!      F1      -  NAME EINES EXTERNEN UNTERPROGRAMMS, WIRD VON DNLQ1
!                 SELBST NICHT VERWENDET, SONDERN ALS PARAMETER AN
!                 DIE SUBROUTINE F WEITERGEGEBEN
!      EPSREL  -  ABBRUCHSCHRANKE FUER RELATIVE AENDERUNG VON X (E)
!      EFX     -  ABBRUCHSCHRANKE FUER DEFEKT
!                  E: GEFORDERTER MINIMALER WERT VON ENORM(F(X))
!                  A: DEFEKT ENORM(F(XSTERN))
!      EGRAD   -  ABBRUCHSCHRANKE FUER GRADIENTENNORM
!                  E: GEFORDERTER MINIMALER WERT FUER ENORM(GSTR(X))
!                  A: ENORM(GSTRICH(XSTERN)) BEI IE=1,
!                     ENORM(GSTRICH(X(K-1))) SONST
!      ITM     -  ITERATIONSANZAHL
!                  E: MAXIMALE ITERATIONSANZAHL
!                  A: ANZAHL DER DURCHGEFUEHRTEN ITERATIONEN
!      IPRINT  -  STEUERGROESSE
!                  E: DRUCKSTEUERGROESSE:
!                      0: KEIN DRUCK
!                      1: DRUCK DER START- UND ENDWERTE
!                      2: WIE 1, ZUSAETZLICH TABELLE MIT ENDWERTEN
!                         JEDES ITERATIONSSCHRITTES (AUSSER X(K))
!                      3: WIE 2, ZUSAETZLICH ALLE ZWISCHENWERTE JEDES
!                         ITERATIONSSCHRITTES (AUSSER X(K))
!                      4: WIE 3, ZUSAETZLICH DER NEUE NAEHERUNGSVEKTOR
!                  A: ANZAHL DER AUFRUFE VON F
!      IE      -  STEUERGROESSE
!                  E: STEUERGROESSE FUER SPEICHERBELEGUNG:
!                      0: FUER EVTL. MEHRMALIGE VERWENDUNG WIRD EIN
!                         DUPLIKAT DER JACOBIMATRIX GESPEICHERT
!                      1: JACOBI-MATRIX WIRD VOR JEDER VERWENDUNG NEU
!                         BERECHNET
!                  A: FEHLERINDIKATOR:
!                     -1: DIMENSIONSFEHLER (M<N ODER N<1)
!                      0: ENOR(F(XSTERN))<=EFX
!                      1: ENORM(GSTR(XSTERN)) <= EGRAD
!                      2: ENORM(X(K-1)-X(K)) <= EPSREL*
!                                                (ENORM(X(K-1))+1D-5)
!                      3: MAXIMALE ITERATIONSANZAHL ERREICHT
!                      4: KEIN ABSTIEGSPUNKT AUFFINDBAR
!                         ( ENORM(F(X(K)))=ENORM(F(X(K-1))) )
!                      5: F(X0) NICHT BERECHENBAR
!                      6: ABLEITUNG FSTR AN DER STELLE X NICHT BE-
!                         RECHENBAR
!      WORK    -  ARBEITSFELD MIT
!                  -  3*N + 2*M + 2*M*N  ELEMENTEN BEI IE=0
!                  -  3*N + 2*M + M*N    ELEMENTEN BEI IE=1
!
!
!     ANWENDERSUBROUTINE F:
!
!      SUBROUTINE F(N,X,M,FX,F1,IER)
!      REAL*8 X(N),FX(M)
!
!      PARAMETER FUER F:
!       N      -  ANZAHL DER UNBEKANNTEN
!       M      -  ANZAHL DER GLEICHUNGEN
!       X      -  ARGUMENTFELD (E), DIE ERSTEN N ELEMENTE ENTHALTEN
!                 DEN ARGUMENTVEKTOR X (DIESES FELD IST IDENTISCH MIT
!                 DEM GLEICHNAMIGEN PARAMETER VON DNLQ1)
!       FX     -  FELD MIT M ELEMENTEN (A)
!                  FX MUSS BEI VERLASSEN VON F DEN WERT VON F(X) AN
!                  DER IM FELD X GESPEICHERTEN ARGUMENTSTELLE ENT-
!                  HALTEN (IER=0)
!       F1     -  NAME EINES EXTERNEN UNTERPROGRAMMS, IST IDENTISCH
!                 MIT DEM DNLQ1 VERMITTELTEN UP-NAMEN F1
!       IER    -  IN F ZU BELEGENDER FEHLERINDIKATOR
!                  0: FX ENTHAELT DEN FUNKTIONSWERT F(X)
!                  UNGLEICH 0: BERECHNUNG VON F(X) NICHT MOEGLICH,
!                              FX ENTHAELT KEINE WERTE
!
!
! OUTPUT
!  -
!  
! USED PROGRAMS
!  typedef.f90 (Module typedef)
!
! LITERATURE
!
! Press, W.H. and Teukolsky, S.A. and W.T. Vetterling, and Flannery, B.P.
! Numerical Recipes in FORTRAN -The Art of scientific computing
! Cambridge University Press, 1992
!
! SOURCE                         
!    
!--------------------------------------------------------------------------
!                  
      SUBROUTINE DNLQ1(N,X,M,F,F1,EPSREL,EFX,EGRAD,ITM,IPRINT,IE,WORK)
      USE typedef 
      REAL(DP) :: X(1),WORK(1)
      REAL(DP) :: EPSREL,EFX,EGRAD
      EXTERNAL F1
!
      REAL(DP) :: LAMBDA,LAMK,SUM,GSTPN,X0J,EP,EPSF,EPSGS,EFX0,GAMMA,GAMMK, &
                  XKORR,XKORR0,HKORR,HMAX,ALPHA,HJ,GOLDST,GOLD0,GOLD1, &
                  GAM0,GAM1
      EQUIVALENCE (SUM,GSTPN),(X0J,EP)
      REAL(DP) :: DENORM
!
      CHARACTER *20 BEFUND(7)
      DATA BEFUND/'NORM(FX) .LE. EFX   ',     &       
                  'STATIONAERER PUNKT  ',     &         
                  'REL. GENAUIGKEIT X  ',     &        
                  'ITERATIONSANZAHL    ',     &        
                  'KEIN ABSTIEGSPUNKT  ',     &         
                  'FX0 NICHT BERECHENB.',     &           
                  'F'' NICHT BERECHENBAR'/              
      DATA ISYSPR/0/
!
!     PRUEFUNG DER EINGANGSPARAMETER N UND M
!
      ITSTEP=0
      IF(N)20,20,10
   10 IF(M-N)20,30,30
   20 IE=-1
      GOTO 90010
!
!     BERECHNUNG DER LEITINDIZES IM ARBEITSFELD WORK
!
      LP=1
   30 LF0=N+1
      LD=LF0+M
      LGSTR=LD+N
      LA=LGSTR+N
      LAA=LA
      LM2=LA+M*N
      IF(IE)50,40,50
   40 LAA=LM2+M
!
   50 LF0M=LD-1
      LGSTRN=LA-1
!
   51 IF(IPRINT)54,54,52
   52 WRITE(ISYSPR,53) N,M,ITM,IPRINT,IE,EPSREL,EGRAD,EFX,(X(I),I=1,N)
   53 FORMAT(1H0,30(4H*--*)/&
      16H0PROTOKOLL DNLQ1/&
      11H0PARAMETER:,9X,2HN=,I4,2X,2HM=,I4,2X,4HITM=,I5,2X,7HIPRINT=,I2,&
      2X,3HIE=,I2,2X,7HEPSREL=,1PD10.3,2X,6HEGRAD=,1PD10.3,2X, &
      4HEFX=,1PD10.3//16H STARTVEKTOR X0:,1P4D25.15/(16X,4D25.15))     
   54 CONTINUE
!
!     PRUEFUNG STARTVEKTOR X UND VORBEREITEN ITERATION
!
  100 EPSF=EFX
      EPSGS=EGRAD
      CALL F(N,X,M,WORK(LF0),F1,IFEX)
      IFCT=1
      IF(IFEX)9500,110,9500
  110 EFX0=DENORM(M,WORK(LF0))
      EFX=EFX0
      IF(EFX0-EPSF)9000,9000,120
  120 GAMMA=1D0
      LAMK=1D0
      GAMMK=1D0
      XKORR=1D0
      XKORR0=1D70
      IAA=-1
!
  121 IF(IPRINT)129,129,122
  122 WRITE(ISYSPR,123)EFX
  123 FORMAT(16H NORM(F(X0))   :,1PD25.15)
  124 IF(IPRINT-2)129,125,125
  125 WRITE(ISYSPR,126)EFX
  126 FORMAT(/7H0ITSCHR,9X,10HNORM(F(X)),9X,&
      42HNORMGRAD   KORREKTUR     LAMBDA      GAMMA,8X,&
      34HGOLDST  ILAM IGAM     FZ      HMAX//6X,1H0,1PD24.15)
  129 CONTINUE
!
!     BEGINN DES ITERATIONSSCHRITTES
!
 1000 ITSTEP=ITSTEP+1
      HKORR=DSQRT(XKORR0*XKORR)+1D-10
      XKORR0=XKORR
      JG=10
      IE4=0
 1001 HMAX=0D0
 1002 ILAM=0
      IGAM=0
!
!     BERECHNUNG VON JACOBI-MATRIX, GRADIENT UND REG.-GEWICHTE D
!
 2000 IF(IE)2500,2010,2500
 2010 IF(EFX0-1D-5)2020,2020,2500
 2020 IF(IAA)2500,2500,2100
!
!     UEBERNAHME DER JACOBI-MATRIX UND D AUS VORHERGEHENDEM SCHRITT
!
 2100 L1=LAA
      DO 2120 J=LGSTR,LGSTRN
      SUM=0D0
      DO 2110 I=LF0,LF0M
      SUM=SUM+WORK(L1)*WORK(I)/EFX
 2110 L1=L1+1
 2120 WORK(J)=SUM*EFX
      IAA=IAA-1
      GOTO 2900
!
!     NEUBERECHNUNG DER JACOBI-MATRIX UND DER REG.-GEWICHTE D
!
 2500 I=LGSTR
      L1=LAA
      DO 2600 J=1,N
      X0J=X(J)
      HJ=DMIN1(1D-4*(DABS(X0J)+1D-3),HKORR)
 2510 X(J)=X0J-HJ
      CALL F(N,X,M,WORK(L1),F1,IFEX)
      IFCT=IFCT+1
      IF(IFEX)2520,2550,2520
 2520 HJ=-HJ
      IF(HJ)2510,2530,2530
 2530 HJ=0.1D0*HJ
      X(J)=X0J
      IF(HJ-1D-10*(DABS(X0J)+1D-3))9600,9600,2510
 2550 I1=L1
 2551 HMAX=DMAX1(HMAX,DABS(HJ))
      SUM=0D0
      DO 2560 IFEX=LF0,LF0M
      WORK(L1)=(WORK(IFEX)-WORK(L1))/HJ
      SUM=SUM+WORK(L1)*WORK(IFEX)/EFX
 2560 L1=L1+1
      WORK(I)=SUM*EFX
      WORK(I-N)=DENORM(M,WORK(I1))+1D-3
      X(J)=X0J
 2600 I=I+1
      IAA=N
!
 2900 EGRAD=DENORM(N,WORK(LGSTR))
      IF(EGRAD-EPSGS)9100,9100,3000
!
!     BESTIMMUNG DER ABSTIEGSRICHTUNG
!
 3000 LAMBDA=GAMMA
 3001 ICLAM=-1
 3002 IF(ILAM-10)3004,3004,3003
 3003 ILAM=ILAM-1
      GOTO 5700
 3004 ILAM=ILAM+1
      ALPHA=DSQRT((1D0-LAMBDA)/LAMBDA)
 3100 IF(IE)3130,3110,3130
 3110 I1=LAA
      IFEX=LM2-1
      DO 3120 I=LA,IFEX
      WORK(I)=WORK(I1)
 3120 I1=I1+1
 3130 I1=LM2
      DO 3140 I=LF0,LF0M
      WORK(I1)=WORK(I)
 3140 I1=I1+1
      CALL DLSRH(M,N,ALPHA,WORK(LD),WORK(LA),WORK,IFEX)
      IF(IFEX)3300,3200,3300
 3200 GSTPN=0D0
      I1=LGSTR
      DO 3210 J=1,N
      WORK(J)=WORK(J)/LAMBDA
      GSTPN=GSTPN+WORK(J)/EFX0*WORK(I1)/EFX0
 3210 I1=I1+1
      IF(GSTPN)3300,3300,3500
 3300 GAMMA=0.9D0*GAMMA
 3310 IF(IE)2500,3000,2500
 3500 EP=DENORM(N,WORK)
!
!     BERECHNUNG EINES NEUEN PUNKTES X
!
 4000 DO 4010 I=1,N
 4010 WORK(LGSTRN+I)=X(I)
      J=-1
      L1=LM2
      L2=LF0
!
 4100 XKORR=GAMMA*EP
      DO 4110 I=1,N
 4110 X(I)=WORK(LGSTRN+I)-GAMMA*WORK(I)
      IF(JG)4310,4120,4120
 4120 CALL F(N,X,M,WORK(L1),F1,IFEX)
      IFCT=IFCT+1
      IGAM=IGAM+1
      IF(IFEX)4200,4300,4200
 4200 GAMMA=0.1D0*GAMMA
 4210 IF(HKORR)4240,4240,4220
 4220 DO 4230 I=1,N
 4230 X(I)=WORK(LGSTRN+I)
      GOTO 3310
 4240 GAMMA=-HKORR
      EFX=HJ
      L1=L2
 4241 ICLAM=-1
      JG=-1
      GOTO 4100
 4300 EFX=DENORM(M,WORK(L1))
 4310 ALPHA=EFX/EFX0
      ALPHA=1D0-ALPHA*ALPHA
      GOLDST=0.5D0*ALPHA/GAMMA/GSTPN
!
 4401 IF(IPRINT-3)4411,4402,4402
 4402 IFEX=-1
 4403 WRITE(ISYSPR,4404)EFX,XKORR,GAMMA,GOLDST,IGAM,IFCT
 4404 FORMAT(1PD31.15,2E24.3,E13.3,I10,I7)
 4405 IF(ICLAM)4406,4409,4409
 4406 WRITE(ISYSPR,4407)LAMBDA
 4407 FORMAT(1H+,1PD66.3)
 4408 ICLAM=IGAM
 4409 IF(IFEX)4411,6004,6004
 4411 CONTINUE
!
      IF(JG)5900,4500,4500
 4500 IF(EFX-EPSF)4600,4600,5000
 4600 LF0=L1
      LF0M=L1+M-1
      GOTO 9000
!
!     SCHRITTWEITENSTRATEGIE:  GOLDSTEIN - PEGASUS - REGULA FALSI
!
 5000 JG=JG-1
      IF(GOLDST-0.145D0)5500,5500,5100
 5100 IF(J)5110,5200,5200
 5110 IF(0.999999D0-GAMMA)6000,6000,5120
 5120 J=0
 5200 IF(JG)5900,5900,5210
 5210 ISW2=1
      HKORR=-GAMMA
      HJ=EFX
      IFEX=L1
      L1=L2
      L2=IFEX
      IF(J)5300,5300,5800
 5300 GAM0=GAMMA
      GOLD0=GOLDST
      GAMMA=0.9D0*GAMMA/(1D0-DMAX1(0.15D0,DMIN1(GOLDST,0.98D0)))
      GOTO 4100
 5500 IF(GOLDST-0.045D0)5510,5900,5900
 5510 IF(DABS(EFX-EFX0)-1D-15*(EFX0+1D-3))5700,5700,5520
 5520 IF(IE4)5530,5530,5720
 5530 IF(JG)5710,5710,5540
 5540 ISW2=-1
      IF(J)5600,5610,5800
 5600 GAM0=0D0
      GOLD0=1D0
 5610 ISW1=-1
      J=1
 5620 GAM1=GAMMA
      GOLD1=GOLDST
      IF(IGAM-1)5630,5630,5640
 5630 IF(GOLDST+10D0)5660,5640,5640
 5640 ALPHA=(GOLDST-0.1D0)/(GOLDST-GOLD0)*(GAM1-GAM0)
      IF(DABS(ALPHA)-1.D-4)5710,5710,5650
 5650 GAMMA=GAM1-ALPHA
      IF(GAMMA-1D-10)5710,5710,4100
 5660 GAMMA=0.1D0*GAMMA
      GOTO 4100
!
!     KORREKTUR VON GAMMA ZU KLEIN  -  NOTSCHRITT
!
 5700 IF(IE4)5710,5710,9400
 5710 IE4=1
      IE=1
      GAMMA=0.5D0
 5720 GAMMA=0.1D0*GAMMA
      JG=1
      IF(ILAM-10)4210,2500,2500
 5800 IF(ISW1*ISW2)5810,5810,5820
 5810 GAM0=GAM1
      GOLD0=GOLD1
      GOTO 5830
 5820 GOLD0=(GOLD1-0.1D0)/(GOLD1+GOLDST-0.2D0)*(GOLD0-0.1D0)
 5830 ISW1=ISW2
      GOTO 5620
 5900 IAA=-1
!
!     ABSTIEGSPUNKT GEFUNDEN - VORBEREITEN NEUEN ITERATIONSSCHRITT
!
 6000 EFX0=EFX
 6001 IFEX=0
 6002 ICLAM=ICLAM-IGAM
 6003 IF(IPRINT-2)6012,4403,4405
 6004 WRITE(ISYSPR,6005)ITSTEP,EGRAD,ILAM,HMAX
 6005 FORMAT(1H+,I6,1PD36.3,I54,E24.3)
 6006 IF(IFEX)6007,6007,9902
 6007 IF(IPRINT-4)6012,6008,6008
 6008 WRITE(ISYSPR,6009)ITSTEP,(X(I),I=1,N)
 6009 FORMAT(/I10,14H-TE ITERIERTE:,1P4D24.15/(24X,4D24.15))
 6011 WRITE(ISYSPR,4404)
 6012 CONTINUE
      DO 6020 I=LF0,LF0M
      WORK(I)=WORK(L1)
 6020 L1=L1+1
      IF(XKORR-EPSREL*(DENORM(N,X)+1D-5))9200,9200,6100
!
!     ERMITTLUNG EINES SCHAETZWERTES FUER NEUES GAMMA
!
 6100 IF(LAMBDA-GAMMA)6110,6110,6120
 6110 GAMMA=DMAX1(GAMMA,1.5D0*LAMBDA)
 6120 GOLDST=GAMMA-LAMBDA
      ALPHA=GAMMK-LAMK
      GAMMK=GAMMA
      IF(ALPHA*GOLDST)6130,6140,6140
 6130 GAMMA=LAMK+ALPHA/(ALPHA-GOLDST)*(LAMBDA-LAMK)
      GOTO 6150
 6140 GAMMA=DMIN1(1D0,    &
      ((2D0*LAMBDA-1D0)*0.98D0+1D0-LAMBDA)*(LAMBDA-GAMMA)+GAMMA)
 6150 LAMK=LAMBDA
      IF(ITSTEP-ITM)1000,9300,9300
!
!     ENDE DER ITERATION - VORBEREITUNG DES RUECKSPRUNGS
!
!     NORMF-MINIMUM ERREICHT:  NORM(F(X)) <= EFX
      write(*,*) '9000'
 9000 IE=0
 9001 IFEX=1
 9002 IF(IPRINT-1)90000,9902,9003
 9003 IF(ITSTEP)90000,9902,9004
 9004 IF(IPRINT-2)90000,4403,9005
 9005 ICLAM=ICLAM-IGAM
 9006 IF(ILAM-10)4405,4403,4403
!
!     STATIONAERER PUNKT ERREICHT:  NORM(GSTRICH) <= NORMGS
!
 9100 IE=1
      GOTO 9901
!
!     RELATIVE GENAUIGKEIT FUER X ERREICHT:  XKORR <= EPSREL*NORM(X)
!
 9200 IE=2
      GOTO 9901
!
!     MAXIMALE ITERATIONSANZAHL ERREICHT:  ITSTEP = ITMAX
!
 9300 IE=3
      GOTO 9901
!
!     KEIN ABSTIEGSPUNKT AUFFINDBAR:  NORM(F(K)) = NORM(F(K-1))
!
 9400 IE=4
      GOTO 9001
!
!     STARTVEKTOR UNGEEIGNET:  F(X0) NICHT BERECHENBAR
!
 9500 IE=5
      GOTO 9901
!
!     ABLEITUNG NICHT BERECHENBAR
!
 9600 IE=6
!
 9901 IF(IPRINT)90000,90000,9902
!
 9902 CONTINUE
      WRITE(ISYSPR,9903)ITSTEP,IE,BEFUND(IE+1),(X(I),I=1,N)
 9903 FORMAT(/10H0ENDE NACH,I5,23H ITERATIONEN WEGEN IE =,I2,10X,A/ &
      20H0LETZTE ITERIERTE X:,1P4D25.15/(20X,4D25.15))
      WRITE(ISYSPR,9904) (WORK(I),I=LF0,LF0M)
 9904 FORMAT(20H FUNKTIONSWERT F(X): ,1P4D25.15/(20X,4D25.15))
 9906 WRITE(ISYSPR,9907)EFX,EGRAD,IFCT
 9907 FORMAT(11H NORM(F(X)),8X,1H:,1PD25.15/   &
      20H NORM D. GRADIENTEN:,D25.15/          &
      20H AUFRUFE VON F     :,I9/              &  
      11H0ENDE DNLQ1/1H0,30(4H*--*)//)
!
90000 IPRINT=IFCT
90010 ITM=ITSTEP
      RETURN
      END
!     SUBROUTINE DLSRH(M,N,ALPHA,D,A,X,IE)
!     DOUBLE PRECISION ALPHA
!     DOUBLE PRECISION D(N),A(N*M+M),X(N)
!
!     BERECHNUNG DER QUADRATMITTELLOESUNG X=X(J) DES DURCH
!     ALPHA*D(J)*X(J)=0 REGULARISIERTEN UEBERBESTIMMTEN LINEAREN
!     GLEICHUNGSSYSTEMS C*X=B MIT C=C(I,J), B=B(I) DURCH ORTHO-
!     GONALE REDUKTION AUF DREIECKSFORM NACH HOUSEHOLDER (I=1(1)M,
!     J=1(1)N, M.GE.N).
!     C UND B SIND IN DER (N+1)-SPALTIGEN MATRIX A ZUSAMMENGEFASST.
!
!     ALLE RECHNUNGEN WERDEN MIT DOPPELTER GENAUIGKEIT AUSGEFUEHRT.
!
!     INPUT-PARAMETER:
!       M      ANZAHL DER GLEICHUNGEN IN C*X=B
!       N      ANZAHL DER UNBEKANNTEN (N.LE.M)
!       ALPHA  REGULARISIERUNGSPARAMETER
!                (BEI ALPHA=0.0 WIRD REGULARISIERUNG UNTERDRUECKT)
!       D      GEWICHTSVEKTOR D(J), J=1(1)N FUER REGULARISIERUNG
!                (BEI ALPHA=0.0 WIRD D NICHT BENOETIGT, ES KANN
!                 D=X GESETZT WERDEN)
!       A      KOEFFIZIENTENMATRIX A(I,J), I=1(1)M, J=1(1)N+1
!                A(I,J)=C(I,J) UND A(I,N+1)=B(I), I=1(1)M, J=1(1)N
!                (A ENTHAELT ALS (N+1)-TE SPALTE DIE RECHTE SEITE B)
!       X      FREIER VEKTOR X(J), J=1(1)N
!                (X DARF NICHT MIT B IDENTIFIZIERT WERDEN)
!
!     OUTPUT-PARAMETER:
!       A      ZERSTOERT
!       X      LOESUNGSVEKTOR X(J), J=1(1)N
!       IE     ABBRUCHPARAMETER:
!               IE=0:  LOESUNG GEFUNDEN
!               IE=J:  KEINE LOESUNG, DA SPALTE J (1.LE.J.LE.N)
!                      NUMERISCH ABHAENGIG VON DEN SPALTEN
!                      1 ... J-1
!
!
!     *****************************************************************
!
      SUBROUTINE DLSRH(M,N,ALPHA,D,A,X,IE)
      DOUBLE PRECISION ALPHA,D(1),A(1),X(1)
!
      DOUBLE PRECISION SUM,SIGMA,ZWEIKQ,XJ,AJJ
      EQUIVALENCE (ZWEIKQ,XJ)
!
!
!     REDUKTION AUF DREIECKSFORM DURCH ORTHOGONALISIERUNG
!      I0J:  INDEX DES PIVOTZEILENELEMENTS A(I0,J)
!      MJ :  INDEX DES LETZTEN ELEMENTS A(M,J) IN PIVOTSPALTE J
!
      I0J=1
      MJ=M
   10 DO 220 J=1,N
!     J-TER ORTHOGONALISIERUNGSSCHRITT
!
!     BERECHNUNG DER SPALTENNORM
      SUM=ALPHA
      IF(ALPHA)20,30,20
   20 SUM=D(J)*SUM
      SUM=SUM*SUM
   30 DO 40 IJ=I0J,MJ
   40 SUM=A(IJ)*A(IJ)+SUM
!
!     TEST AUF REGULARITAET
      IF(SUM)9000,9000,50
!
   50 SIGMA=DSQRT(SUM)
      AJJ=A(I0J)
      IF(AJJ)70,70,60
   60 SIGMA=-SIGMA
   70 ZWEIKQ=SUM-AJJ*SIGMA
      A(I0J)=AJJ-SIGMA
!
!     BERECHNUNG DER SPALTENMULTIPLIKATOREN
!
      IH=I0J  
      DO 90 K=J,N
      IH=IH+M
      IK=IH
      SUM=0D0
      DO 80 IJ=I0J,MJ
      SUM=A(IJ)*A(IK)+SUM
   80 IK=IK+1
   90 X(K)=-SUM/ZWEIKQ
!
!     ZEILENWEISE TRANSFORMATION DER NICHTPIVOTZEILEN
      IF(N-J)140,140,100
  100 IH=I0J+1
      DO 130 IJ=IH,MJ
      AJJ=A(IJ)
      IF(AJJ)110,130,110
  110 IK=IJ
      DO 120 K=J,N
      IK=IK+M
  120 A(IK)=AJJ*X(K)+A(IK)
  130 CONTINUE
!
!     BERECHNUNG VON ZEILE J DES GESTAFFELTEN SYSTEMS R*X=S
!     DIAGONALELEMENT R(J,J) NACH A(J,J)
  140 AJJ=A(I0J)
      IJ=MJ-M+J
      A(IJ)=SIGMA
!     NICHTDIAGONALELEMENTE R(J,K) NACH A(K,J), K=J+1(1)N
      K=J
      IK=I0J+M
  150 IF(N-K)170,170,160
  160 IJ=IJ+1
      A(IJ)=AJJ*X(K)+A(IK)
      IK=IK+M
      K=K+1
      GOTO 150
  170 XJ=AJJ*X(N)+A(IK)
!
!     TRANSFORMATION VON ZEILE J DES REGULARISIERTEN TEILS UND
!     EINTRAGEN IN ZEILE 1
      IF(ALPHA)180,200,180
  180 IK=MJ+1
      I0J=IK
      SUM=ALPHA*D(J)
      DO 190 K=J,N
      A(IK)=SUM*X(K)
  190 IK=IK+M
      GOTO 210
!
  200 I0J=I0J+M+1
!
  210 X(J)=XJ
  220 MJ=MJ+M
!
!     RUECKRECHNUNG - LOESUNG DES GESTAFFELTEN SYSTEMS R*X=S
!
      J=N
      IJ=MJ-M-M+N
      SUM=0D0
      GOTO 330
  310 IK=IJ
      SUM=0D0
      DO 320 K=IH,N
      IK=IK+1
  320 SUM=A(IK)*X(K)+SUM
  330 X(J)=(X(J)-SUM)/A(IJ)
      IJ=IJ-M-1
      IH=J
      J=J-1
      IF(J)400,400,310
!     ENDE DER RUECKRECHNUNG
!
  400 IE=0
  999 RETURN
!
!     SPALTE J NUMERISCH ABHAENGIG VON SPALTEN 1 ... J-1
 9000 IE=J
      GOTO 999
      END
      DOUBLE PRECISION FUNCTION DENORM(N,VEKTOR)
      DOUBLE PRECISION VEKTOR(1)
!
!     BERECHNUNG DER EUKLIDISCHEN VEKTORNORM
!
      DOUBLE PRECISION VMAX,SUM,VI
!
      VMAX=0D0
      SUM=0D0
      DO 10 I=1,N
   10 VMAX=DMAX1(VMAX,DABS(VEKTOR(I)))
      IF(VMAX)40,40,20
   20 DO 30 I=1,N
      VI=VEKTOR(I)/VMAX
   30 SUM=SUM+VI*VI
   40 DENORM=VMAX*DSQRT(SUM)
      RETURN
      END
!***
